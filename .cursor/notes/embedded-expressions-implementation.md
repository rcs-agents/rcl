# Embedded Expressions Implementation for RCL

## Overview

Successfully implemented TextMate grammar support for RCL's embedded expression syntax (formerly called "Expressions" in the specification). This implementation correctly handles RCL's indentation-based syntax for multi-line expressions.

## Expression Syntax Patterns

### Single-line Expressions
- **JavaScript**: `$js> code...`
- **TypeScript**: `$ts> code...`
- **Generic**: `$> code...`

### Multi-line Expressions (Indentation-based)
- **JavaScript**: `$js>>>` followed by indented block
- **TypeScript**: `$ts>>>` followed by indented block
- **Generic**: `$>>>` followed by indented block

## TextMate Grammar Implementation

### Key Patterns Added

1. **Single-line patterns**: Match from marker to end of line
   ```json
   {
     "begin": "(\\$js>)\\s*",
     "end": "$",
     "contentName": "source.js"
   }
   ```

2. **Multi-line patterns**: Handle indentation-based blocks correctly
   ```json
   {
     "begin": "^(\\s*)(\\$js>>>)\\s*$",
     "end": "^(?!\\1\\s+\\S)",
     "contentName": "source.js"
   }
   ```

### Indentation Handling

The multi-line patterns use regex capture groups to:
- `(\\s*)` - Capture the indentation level of the marker line
- `^(?!\\1\\s+\\S)` - End when a line doesn't have more indentation than the marker

This correctly implements RCL's INDENT/DEDENT token behavior using TextMate's regex capabilities.

## Files Modified

### `packages/extension/esbuild.mjs`
- Added grammar extension logic for all 6 expression patterns
- Implemented proper indentation-based matching for multi-line blocks
- Added patterns to main grammar during build process

### `examples/expressions_example.rcl`
- Created comprehensive example demonstrating all expression patterns
- Shows single-line and multi-line usage for each language type
- Demonstrates proper indentation structure

## Language Server Support

The existing `EmbeddedCodeValidator` already supports these patterns:
- Language detection from markers (`$js>`, `$ts>`, `$>`, etc.)
- Syntax validation for JavaScript/TypeScript content
- Proper handling of both single-line and multi-line blocks
- Warning/error reporting for empty or invalid expressions

## Technical Notes

### Why Indentation Matters
RCL is indentation-sensitive like Python or YAML. The formal specification shows that multi-line expressions are terminated by `DEDENT` tokens generated by the lexer when indentation decreases.

### TextMate Limitations
TextMate grammars can't generate INDENT/DEDENT tokens like Langium's lexer, so we simulate this behavior using regex patterns that track the initial indentation level and detect when subsequent lines don't maintain the required indentation.

### Testing
The implementation should be tested with VS Code's embedded language features:
- JavaScript/TypeScript syntax highlighting within expressions
- IntelliSense and autocompletion
- Error highlighting for syntax issues
- Proper block folding for multi-line expressions

## Future Improvements

1. **Content extraction for multi-line blocks**: The validator currently returns null for multi-line content extraction, which could be improved with CST traversal
2. **Better TypeScript integration**: Real TypeScript compiler integration for type checking
3. **Context-aware validation**: Validate that expressions have access to expected `context` and `RclUtils` variables